
name: Deploy to Kubernetes (Staging/Prod)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY || 'ghcr.io' }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build & push image
        run: |
          IMAGE=${{ secrets.IMAGE || format('ghcr.io/{0}/quantum-wallet-backend', github.repository_owner) }}
          TAG=${{ github.sha }}
          docker build -t $IMAGE:$TAG .
          docker push $IMAGE:$TAG
          echo "IMAGE_OUT=$IMAGE:$TAG" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Apply manifests
        run: |
          kubectl apply -f k8s/otel-collector.yaml
          kubectl create secret generic api-secrets -n quantum-wallet             --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}"             --from-literal=FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"             --from-literal=REDIS_URL="${{ secrets.REDIS_URL }}"             --from-literal=ADMIN_UID="${{ secrets.ADMIN_UID }}"             --dry-run=client -o yaml | kubectl apply -f -
          sed -e "s|REPLACE_WITH_REGISTRY_IMAGE:latest|${{ env.IMAGE_OUT }}|g" k8s/api-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/api-ingress.yaml

      - name: Wait for rollout
        run: |
          kubectl -n quantum-wallet rollout status deploy/quantum-wallet-api --timeout=180s
          kubectl -n quantum-wallet get pods -o wide
